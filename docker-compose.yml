# ============================================================================
# WhisperCache Docker Compose - Full Stack
# ============================================================================
# Complete development and production setup with monitoring
# 
# Usage:
#   Development:  docker-compose up backend frontend redis
#   Production:   docker-compose --profile production up -d
#   Monitoring:   docker-compose --profile monitoring up -d
#   Full Stack:   docker-compose --profile production --profile monitoring up -d

version: '3.8'

# ==========================================================================
# Common Configurations
# ==========================================================================
x-common-env: &common-env
  TZ: UTC
  LOG_LEVEL: ${LOG_LEVEL:-info}

x-healthcheck-defaults: &healthcheck-defaults
  interval: 30s
  timeout: 10s
  retries: 3
  start_period: 10s

services:
  # ==========================================================================
  # Backend API Server
  # ==========================================================================
  backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      target: ${DOCKER_TARGET:-production}
    container_name: whispercache-backend
    restart: unless-stopped
    ports:
      - "${API_PORT:-4000}:4000"
      - "${METRICS_PORT:-9090}:9090"
    environment:
      <<: *common-env
      NODE_ENV: ${NODE_ENV:-production}
      PORT: 4000
      DATABASE_TYPE: sqlite
      DATABASE_PATH: /app/data/whispercache.db
      BLOCKCHAIN_MODE: ${BLOCKCHAIN_MODE:-simulation}
      MIDNIGHT_NETWORK: ${MIDNIGHT_NETWORK:-devnet}
      CARDANO_NETWORK: ${CARDANO_NETWORK:-preview}
      CORS_ORIGINS: ${CORS_ORIGINS:-http://localhost:3000,http://localhost:5173}
      REDIS_URL: redis://redis:6379
      METRICS_ENABLED: "true"
    volumes:
      - backend-data:/app/data
      - ./zk/circuits:/app/zk/circuits:ro
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4000/api/health"]
    networks:
      - whispercache-network
    depends_on:
      redis:
        condition: service_healthy

  # ==========================================================================
  # Frontend Web App
  # ==========================================================================
  frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      target: ${DOCKER_TARGET:-production}
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:4000}
        VITE_WS_URL: ${VITE_WS_URL:-ws://localhost:4000}
        VITE_APP_ENV: ${NODE_ENV:-production}
    container_name: whispercache-frontend
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:80"
    healthcheck:
      <<: *healthcheck-defaults
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:80/"]
    networks:
      - whispercache-network
    depends_on:
      backend:
        condition: service_healthy

  # ==========================================================================
  # Redis Cache
  # ==========================================================================
  redis:
    image: redis:7-alpine
    container_name: whispercache-redis
    restart: unless-stopped
    ports:
      - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis-data:/data
    command: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - whispercache-network

  # ==========================================================================
  # Prometheus Monitoring
  # ==========================================================================
  prometheus:
    image: prom/prometheus:v2.47.0
    container_name: whispercache-prometheus
    restart: unless-stopped
    ports:
      - "${PROMETHEUS_PORT:-9091}:9090"
    volumes:
      - ./ops/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./ops/alert.rules.yml:/etc/prometheus/alert.rules.yml:ro
      - prometheus-data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--storage.tsdb.retention.time=15d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - whispercache-network
    profiles:
      - monitoring

  # ==========================================================================
  # Grafana Dashboard
  # ==========================================================================
  grafana:
    image: grafana/grafana:10.1.0
    container_name: whispercache-grafana
    restart: unless-stopped
    ports:
      - "${GRAFANA_PORT:-3001}:3000"
    environment:
      - GF_SECURITY_ADMIN_USER=${GRAFANA_USER:-admin}
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin}
      - GF_USERS_ALLOW_SIGN_UP=false
      - GF_SERVER_ROOT_URL=${GRAFANA_ROOT_URL:-http://localhost:3001}
    volumes:
      - ./ops/datasources.yml:/etc/grafana/provisioning/datasources/datasources.yml:ro
      - ./ops/grafana/dashboards.yml:/etc/grafana/provisioning/dashboards/dashboards.yml:ro
      - ./ops/grafana/dashboards:/var/lib/grafana/dashboards:ro
      - grafana-data:/var/lib/grafana
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - whispercache-network
    depends_on:
      - prometheus
    profiles:
      - monitoring

  # ==========================================================================
  # Alertmanager
  # ==========================================================================
  alertmanager:
    image: prom/alertmanager:v0.26.0
    container_name: whispercache-alertmanager
    restart: unless-stopped
    ports:
      - "${ALERTMANAGER_PORT:-9093}:9093"
    volumes:
      - ./ops/alertmanager.yml:/etc/alertmanager/alertmanager.yml:ro
      - alertmanager-data:/alertmanager
    command:
      - '--config.file=/etc/alertmanager/alertmanager.yml'
      - '--storage.path=/alertmanager'
      - '--web.external-url=http://localhost:9093'
      - '--log.level=info'
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9093/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - whispercache-network
    profiles:
      - monitoring

  # ==========================================================================
  # Loki - Log Aggregation
  # ==========================================================================
  loki:
    image: grafana/loki:2.9.0
    container_name: whispercache-loki
    restart: unless-stopped
    ports:
      - "${LOKI_PORT:-3100}:3100"
    volumes:
      - ./ops/logging/loki-config.yaml:/etc/loki/loki-config.yaml:ro
      - loki-data:/loki
    command:
      - '-config.file=/etc/loki/loki-config.yaml'
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3100/ready"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - whispercache-network
    profiles:
      - monitoring

  # ==========================================================================
  # Promtail - Log Collector
  # ==========================================================================
  promtail:
    image: grafana/promtail:2.9.0
    container_name: whispercache-promtail
    restart: unless-stopped
    volumes:
      - ./ops/logging/promtail-config.yaml:/etc/promtail/promtail-config.yaml:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /var/log:/var/log:ro
    command:
      - '-config.file=/etc/promtail/promtail-config.yaml'
    networks:
      - whispercache-network
    depends_on:
      - loki
    profiles:
      - monitoring

  # ==========================================================================
  # PostgreSQL (Production Database)
  # ==========================================================================
  postgres:
    image: postgres:15-alpine
    container_name: whispercache-postgres
    restart: unless-stopped
    ports:
      - "${POSTGRES_PORT:-5432}:5432"
    environment:
      POSTGRES_DB: whispercache
      POSTGRES_USER: ${POSTGRES_USER:-whispercache}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-changeme}
    volumes:
      - postgres-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-whispercache}"]
      interval: 10s
      timeout: 5s
      retries: 3
    networks:
      - whispercache-network
    profiles:
      - production

# ==========================================================================
# Volumes
# ==========================================================================
volumes:
  backend-data:
    driver: local
  redis-data:
    driver: local
  postgres-data:
    driver: local
  prometheus-data:
    driver: local
  grafana-data:
    driver: local
  alertmanager-data:
    driver: local
  loki-data:
    driver: local

# ==========================================================================
# Networks
# ==========================================================================
networks:
  whispercache-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# ============================================================================
# WhisperCache Alertmanager Configuration
# ============================================================================
# Routes alerts from Prometheus to notification channels
# Documentation: https://prometheus.io/docs/alerting/latest/configuration/

global:
  # Default SMTP settings (configure for production)
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alertmanager@whispercache.example.com'
  smtp_auth_username: 'alertmanager@whispercache.example.com'
  smtp_auth_password: '${SMTP_PASSWORD}'  # Use env var or secret
  smtp_require_tls: true

  # Slack API URL (configure for production)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

  # Default resolve timeout
  resolve_timeout: 5m

# ==========================================================================
# Templates for notifications
# ==========================================================================
templates:
  - '/etc/alertmanager/templates/*.tmpl'

# ==========================================================================
# Inhibition Rules
# ==========================================================================
# Prevent noisy alerts when a higher-severity alert is firing
inhibit_rules:
  # If critical is firing, suppress warnings for same alertname
  - source_matchers:
      - severity="critical"
    target_matchers:
      - severity="warning"
    equal:
      - alertname
      - service

  # If service is down, suppress related alerts
  - source_matchers:
      - alertname="WhisperCacheBackendDown"
    target_matchers:
      - service="backend"
    equal:
      - service

# ==========================================================================
# Routing Tree
# ==========================================================================
route:
  # Default receiver
  receiver: 'default-receiver'
  
  # Group alerts by these labels
  group_by: ['alertname', 'service', 'severity']
  
  # Wait before sending first notification for a group
  group_wait: 30s
  
  # Wait before sending updated notifications
  group_interval: 5m
  
  # Wait before resending
  repeat_interval: 4h

  # Child routes for specific alert types
  routes:
    # Critical alerts go to PagerDuty/Slack immediately
    - matchers:
        - severity="critical"
      receiver: 'critical-alerts'
      group_wait: 10s
      repeat_interval: 1h
      continue: true

    # Warning alerts go to Slack
    - matchers:
        - severity="warning"
      receiver: 'warning-alerts'
      group_wait: 1m
      repeat_interval: 4h

    # Security alerts have their own channel
    - matchers:
        - service="security"
      receiver: 'security-alerts'
      group_wait: 10s
      repeat_interval: 30m

    # Infrastructure alerts
    - matchers:
        - service="infrastructure"
      receiver: 'infra-alerts'
      group_wait: 2m
      repeat_interval: 6h

    # ZK prover alerts
    - matchers:
        - service="zk-prover"
      receiver: 'zk-alerts'
      group_wait: 1m
      repeat_interval: 2h

# ==========================================================================
# Receivers
# ==========================================================================
receivers:
  # Default receiver - sends to email
  - name: 'default-receiver'
    email_configs:
      - to: 'ops-team@whispercache.example.com'
        send_resolved: true
        headers:
          Subject: '[WhisperCache] {{ .Status | toUpper }}: {{ .GroupLabels.alertname }}'
        html: |
          {{ range .Alerts }}
          <h2>{{ .Labels.alertname }}</h2>
          <p><b>Severity:</b> {{ .Labels.severity }}</p>
          <p><b>Service:</b> {{ .Labels.service }}</p>
          <p><b>Summary:</b> {{ .Annotations.summary }}</p>
          <p><b>Description:</b> {{ .Annotations.description }}</p>
          <p><b>Started:</b> {{ .StartsAt }}</p>
          {{ if .EndsAt }}<p><b>Ended:</b> {{ .EndsAt }}</p>{{ end }}
          <hr>
          {{ end }}

  # Critical alerts - PagerDuty + Slack + Email
  - name: 'critical-alerts'
    email_configs:
      - to: 'oncall@whispercache.example.com'
        send_resolved: true
    slack_configs:
      - channel: '#whispercache-critical'
        send_resolved: true
        username: 'AlertManager'
        icon_emoji: ':rotating_light:'
        title: '{{ .Status | toUpper }}: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Severity:* {{ .Labels.severity }}
          *Service:* {{ .Labels.service }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ if .Annotations.runbook_url }}*Runbook:* {{ .Annotations.runbook_url }}{{ end }}
          {{ end }}
        actions:
          - type: button
            text: 'View in Grafana'
            url: 'http://grafana:3000/d/whispercache-api'
          - type: button
            text: 'Silence Alert'
            url: 'http://alertmanager:9093/#/silences/new'
    # PagerDuty (uncomment and configure for production)
    # pagerduty_configs:
    #   - service_key: '${PAGERDUTY_SERVICE_KEY}'
    #     severity: critical

  # Warning alerts - Slack only
  - name: 'warning-alerts'
    slack_configs:
      - channel: '#whispercache-alerts'
        send_resolved: true
        username: 'AlertManager'
        icon_emoji: ':warning:'
        title: '{{ .Status | toUpper }}: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Severity:* {{ .Labels.severity }}
          *Summary:* {{ .Annotations.summary }}
          {{ end }}

  # Security alerts - dedicated channel
  - name: 'security-alerts'
    slack_configs:
      - channel: '#whispercache-security'
        send_resolved: true
        username: 'Security Bot'
        icon_emoji: ':shield:'
        title: ':shield: Security Alert: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}
    email_configs:
      - to: 'security@whispercache.example.com'
        send_resolved: true

  # Infrastructure alerts
  - name: 'infra-alerts'
    slack_configs:
      - channel: '#whispercache-infra'
        send_resolved: true
        username: 'Infra Bot'
        icon_emoji: ':gear:'
        title: '{{ .Status | toUpper }}: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Summary:* {{ .Annotations.summary }}
          {{ end }}

  # ZK prover specific alerts
  - name: 'zk-alerts'
    slack_configs:
      - channel: '#whispercache-zk'
        send_resolved: true
        username: 'ZK Bot'
        icon_emoji: ':lock:'
        title: 'ZK Prover: {{ .GroupLabels.alertname }}'
        text: |
          {{ range .Alerts }}
          *Alert:* {{ .Labels.alertname }}
          *Summary:* {{ .Annotations.summary }}
          *Description:* {{ .Annotations.description }}
          {{ end }}

  # Webhook receiver for custom integrations
  - name: 'webhook-receiver'
    webhook_configs:
      - url: 'http://webhook-handler:8080/alerts'
        send_resolved: true
        http_config:
          basic_auth:
            username: 'alertmanager'
            password: '${WEBHOOK_PASSWORD}'
